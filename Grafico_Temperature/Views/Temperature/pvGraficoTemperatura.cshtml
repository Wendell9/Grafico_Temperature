@model TemperatureGraphViewModel

<div id="temperature-graph">

	<script>
		// Variáveis para armazenar dados acumulados globalmente
		var temperaturaAcumulada = [];
		var timestampsAcumuladas = [];

		// Função para calcular a média das temperaturas
		function calcularMedia(temperaturas) {
			const soma = temperaturas.reduce((acc, curr) => acc + curr, 0);
			return soma / temperaturas.length;
		}

		// Função para desenhar o gráfico de temperatura
		function drawTemperatureGraph(timestamps, temperatures) {
			var trace = {
				x: timestamps,
				y: temperatures,
				type: 'scatter',
				mode: 'lines+markers',
				name: 'Temperature',
				line: { color: 'orange' }
			};

			var trace2 = {
				x: timestamps,
				y: new Array(timestamps.length).fill(@Model.SetPoint), // Cria um array com todos os valores de Y iguais a 50
				type: 'scatter',
				mode: 'lines',
				name: 'Set Point',
				line: { color: 'red', dash: 'solid' } // Define a linha como vermelha e sólida
			};

			var layout = {
				title: 'Temperature Over Time',
				xaxis: { title: 'Timestamp' },
				yaxis: { title: 'Temperature (°C)' },
				width: 1000, // Defina a largura desejada
				height: 700 // Defina a altura desejada
			};

			var data = [trace, trace2];

			// Desenha o gráfico
			Plotly.newPlot('temperature-graph', data, layout);
		}

		// Função para obter dados atualizados e redesenhar o gráfico
		function updateGraph() {
			fetch('/Temperature/GetTemperatureData')
				.then(response => response.json())
				.then(data => {
					console.log("Dados recebidos:", data); // Verifica o que está sendo retornado

					// Acumula novos dados
					temperaturaAcumulada = temperaturaAcumulada.concat(data.temperatures);
					timestampsAcumuladas = timestampsAcumuladas.concat(data.timestamps.map(ts => new Date(ts)));

					// Calcular a média das temperaturas acumuladas
					const mediaTemperatura = calcularMedia(temperaturaAcumulada);

					// Exibir a média na página
					document.querySelector("#avgTemperature").textContent = `${mediaTemperatura.toFixed(2)} °C`;


					// Redesenha o gráfico com os dados acumulados
					drawTemperatureGraph(timestampsAcumuladas, temperaturaAcumulada);
				})
				.catch(error => console.error("Erro ao obter dados:", error));
		}

		function updateLastTemperature() {
			var trigger = document.querySelector('[name="Trigger"]').value;
			fetch(`/Temperature/ColetaUltimaTemperatura?trigger=${trigger}`).then(response => response.json())
				.then(data => {
					console.log("Dados recebidos:", data); // Verifica o que está sendo retornado

					const ultimaTemperatura = data.lasttemperature;
					document.querySelector("#lastTemperature").textContent = `${ultimaTemperatura.toFixed(2)} °C`;
				})
				.catch(error => console.error("Erro ao obter dados:", error));
		}

		function startMeasurement() {
			// Verifica o estado do botão de início
			const startButtonText = document.querySelector("#startMeasurementButton").textContent;
			if (startButtonText !== "Parar") {
				return; // Se o texto do botão não for "Parar", o script não faz nada
			}

			// Atualiza o gráfico imediatamente
			updateLastTemperature();
			updateGraph();

			// Configura um intervalo para atualizar o gráfico a cada 60 segundos
			setInterval(() => {
				if (document.querySelector("#startMeasurementButton").textContent !== "Parar") {
					return; // Para as atualizações se o botão não for "Parar"
				}

				// Atualiza o gráfico
				updateGraph();
			}, 60000); // Intervalo de 1 minuto

			// Configura outro intervalo para executar `updateLastTemperature` a cada 15 segundos
			setInterval(() => {
				if (document.querySelector("#startMeasurementButton").textContent !== "Parar") {
					return; // Para as atualizações se o botão não for "Parar"
				}

				// Atualiza a última temperatura
				updateLastTemperature();
			}, 15000); // Intervalo de 15 segundos
		}

		// Inicia a medição
		startMeasurement();


	</script>
</div>
